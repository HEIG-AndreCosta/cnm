
# Lab01 - Session 03 - Prefetching

Follow the steps of the laboratory and complete the information

## Stage 2

We are asking you to use builtin prefetch function to implement prefetching on the convolution task. Please report the metrics here.

### 2.1 metrics

To realize the metrics, we have runned the code with multiple prefetch offset. 

Here is the result of the metrics:

test ./target_O0
|Matrix Size|Prefetch Offset|Time With Prefetch|Time Without Prefetch (us)|
|-|-|-:|-:|
|4|1|3.0|1.0|
|4|2|3.0|0.0|
|4|4|3.0|1.0|
|4|8|2.0|2.0|
|4|16|2.0|1.0|
|4|32|4.0|3.0|
|4|64|2.0|2.0|
|4|128|3.0|1.0|
|8|1|2.0|1.0|
|8|2|3.0|1.0|
|8|4|3.0|1.0|
|8|8|5.0|2.0|
|8|16|3.0|1.0|
|8|32|4.0|2.0|
|8|64|3.0|1.0|
|8|128|3.0|1.0|
|16|1|2.0|1.0|
|16|2|2.0|1.0|
|16|4|3.0|1.0|
|16|8|2.0|2.0|
|16|16|2.0|1.0|
|16|32|5.0|2.0|
|16|64|2.0|1.0|
|16|128|5.0|4.0|
|32|1|3.0|2.0|
|32|2|3.0|2.0|
|32|4|2.0|1.0|
|32|8|4.0|3.0|
|32|16|4.0|2.0|
|32|32|7.0|5.0|
|32|64|3.0|2.0|
|32|128|3.0|1.0|
|64|1|4.0|2.0|
|64|2|3.0|2.0|
|64|4|4.0|3.0|
|64|8|5.0|2.0|
|64|16|3.0|2.0|
|64|32|7.0|4.0|
|64|64|4.0|2.0|
|64|128|8.0|5.0|
|128|1|4.0|2.0|
|128|2|5.0|3.0|
|128|4|4.0|2.0|
|128|8|13.0|6.0|
|128|16|5.0|3.0|
|128|32|8.0|5.0|
|128|64|4.0|3.0|
|128|128|5.0|3.0|
|256|1|7.0|4.0|
|256|2|8.0|5.0|
|256|4|7.0|5.0|
|256|8|13.0|10.0|
|256|16|7.0|4.0|
|256|32|6.0|5.0|
|256|64|7.0|5.0|
|256|128|8.0|5.0|
|512|1|10.0|8.0|
|512|2|20.0|17.0|
|512|4|10.0|9.0|
|512|8|10.0|8.0|
|512|16|11.0|9.0|
|512|32|12.0|10.0|
|512|64|10.0|8.0|
|512|128|10.0|8.0|
|1024|1|18.0|16.0|
|1024|2|18.0|15.0|
|1024|4|18.0|15.0|
|1024|8|37.0|32.0|
|1024|16|18.0|16.0|
|1024|32|37.0|32.0|
|1024|64|18.0|16.0|
|1024|128|18.0|16.0|
|2048|1|42.0|31.0|
|2048|2|42.0|33.0|
|2048|4|34.0|31.0|
|2048|8|69.0|62.0|
|2048|16|34.0|31.0|
|2048|32|70.0|63.0|
|2048|64|34.0|30.0|
|2048|128|33.0|31.0|
|4096|1|66.0|59.0|
|4096|2|71.0|59.0|
|4096|4|67.0|61.0|
|4096|8|135.0|124.0|
|4096|16|66.0|60.0|
|4096|32|66.0|60.0|
|4096|64|67.0|60.0|
|4096|128|66.0|60.0|
|8192|1|128.0|119.0|
|8192|2|150.0|118.0|
|8192|4|132.0|118.0|
|8192|8|270.0|148.0|
|8192|16|128.0|118.0|
|8192|32|268.0|246.00000000000003|
|8192|64|129.0|117.0|
|8192|128|129.0|119.0|
|16384|1|528.0|409.0|
|16384|2|256.0|236.0|
|16384|4|284.0|238.0|
|16384|8|256.0|238.0|
|16384|16|259.0|239.0|
|16384|32|257.0|237.0|
|16384|64|256.0|234.0|
|16384|128|256.0|235.0|
|32768|1|510.00000000000006|476.0|
|32768|2|512.0|478.0|
|32768|4|510.99999999999994|475.0|
|32768|8|1012.0000000000001|492.00000000000006|
|32768|16|509.0|475.0|
|32768|32|1068.0|992.0|
|32768|64|508.0|475.0|
|32768|128|513.0|481.0|
|65536|1|1386.0|951.0|
|65536|2|1018.9999999999999|949.0|
|65536|4|1020.0000000000001|950.0|
|65536|8|1026.0|965.0|
|65536|16|1020.0000000000001|948.0|
|65536|32|1029.0|950.0|
|65536|64|1183.0|951.0|
|65536|128|1412.0|949.0|
|131072|1|2039.0|1902.0|
|131072|2|2033.9999999999998|1909.0|
|131072|4|2033.9999999999998|1911.0|
|131072|8|2040.0000000000002|1903.0|
|131072|16|2063.0|1913.0|
|131072|32|2045.0|1922.0|
|131072|64|2042.0|1902.0|
|131072|128|2037.0000000000002|1908.0|
|262144|1|4084.0|3812.0|
|262144|2|4098.0|3800.0|
|262144|4|4094.9999999999995|3808.0|
|262144|8|4078.0|3811.0|
|262144|16|4079.0|3809.0|
|262144|32|4091.0|3829.0|
|262144|64|4070.0|3807.0|
|262144|128|4075.9999999999995|3808.0|
|524288|1|8154.0|7618.0|
|524288|2|8156.0|7627.0|
|524288|4|8215.0|7658.0|
|524288|8|8197.0|7653.0|
|524288|16|8137.999999999999|7639.0|
|524288|32|8208.0|7673.0|
|524288|64|8144.0|7622.0|
|524288|128|8193.0|7617.0|
Test ./target_O1
|Matrix Size|Prefetch Offset|Time With Prefetch|Time Without Prefetch (us)|
|-|-|-:|-:|
|4|1|2.0|1.0|
|4|2|2.0|1.0|
|4|4|2.0|1.0|
|4|8|3.0|1.0|
|4|16|2.0|1.0|
|4|32|2.0|1.0|
|4|64|2.0|2.0|
|4|128|2.0|1.0|
|8|1|3.0|1.0|
|8|2|2.0|2.0|
|8|4|2.0|1.0|
|8|8|2.0|1.0|
|8|16|4.0|3.0|
|8|32|2.0|1.0|
|8|64|4.0|2.0|
|8|128|2.0|0.0|
|16|1|2.0|1.0|
|16|2|3.0|1.0|
|16|4|2.0|1.0|
|16|8|3.0|1.0|
|16|16|4.0|3.0|
|16|32|2.0|1.0|
|16|64|5.0|2.0|
|16|128|6.0|2.0|
|32|1|2.0|1.0|
|32|2|6.0|3.0|
|32|4|3.0|1.0|
|32|8|2.0|1.0|
|32|16|3.0|1.0|
|32|32|3.0|1.0|
|32|64|7.0|3.0|
|32|128|3.0|2.0|
|64|1|6.0|3.0|
|64|2|3.0|2.0|
|64|4|3.0|1.0|
|64|8|3.0|1.0|
|64|16|6.0|3.0|
|64|32|4.0|1.0|
|64|64|7.0|4.0|
|64|128|3.0|1.0|
|128|1|5.0|1.0|
|128|2|3.0|1.0|
|128|4|4.0|1.0|
|128|8|3.0|2.0|
|128|16|5.0|2.0|
|128|32|4.0|2.0|
|128|64|7.0|4.0|
|128|128|3.0|1.0|
|256|1|6.0|1.0|
|256|2|3.0|1.0|
|256|4|9.0|3.0|
|256|8|5.0|2.0|
|256|16|9.0|3.0|
|256|32|3.0|1.0|
|256|64|4.0|1.0|
|256|128|3.0|2.0|
|512|1|16.0|6.0|
|512|2|7.0|2.0|
|512|4|7.0|4.0|
|512|8|4.0|2.0|
|512|16|4.0|2.0|
|512|32|6.0|2.0|
|512|64|4.0|2.0|
|512|128|11.0|5.0|
|1024|1|23.0|8.0|
|1024|2|5.0|4.0|
|1024|4|15.0|7.0|
|1024|8|9.0|3.0|
|1024|16|7.0|3.0|
|1024|32|9.0|4.0|
|1024|64|12.0|7.0|
|1024|128|6.0|3.0|
|2048|1|36.0|14.0|
|2048|2|14.0|6.0|
|2048|4|16.0|6.0|
|2048|8|15.0|7.0|
|2048|16|11.0|7.0|
|2048|32|11.0|6.0|
|2048|64|15.0|6.0|
|2048|128|9.0|6.0|
|4096|1|23.0|12.0|
|4096|2|16.0|12.0|
|4096|4|52.0|24.0|
|4096|8|24.0|12.0|
|4096|16|50.0|25.0|
|4096|32|20.0|11.0|
|4096|64|54.0|24.0|
|4096|128|16.0|13.0|
|8192|1|39.0|23.0|
|8192|2|33.0|24.0|
|8192|4|29.0|23.0|
|8192|8|34.0|24.0|
|8192|16|60.0|49.0|
|8192|32|30.0|23.0|
|8192|64|60.0|48.0|
|8192|128|34.0|23.0|
|16384|1|56.0|46.0|
|16384|2|56.0|46.0|
|16384|4|59.0|46.0|
|16384|8|56.0|46.0|
|16384|16|117.0|89.0|
|16384|32|60.0|47.0|
|16384|64|117.0|96.0|
|16384|128|66.0|55.0|
|32768|1|230.0|209.0|
|32768|2|112.0|91.0|
|32768|4|230.0|189.0|
|32768|8|111.0|91.0|
|32768|16|111.0|93.0|
|32768|32|111.0|97.0|
|32768|64|111.0|90.0|
|32768|128|229.0|204.0|
|65536|1|219.0|191.0|
|65536|2|454.0|376.0|
|65536|4|220.0|209.0|
|65536|8|220.0|183.0|
|65536|16|220.0|183.0|
|65536|32|222.0|181.0|
|65536|64|220.0|183.0|
|65536|128|220.0|184.0|
|131072|1|436.0|365.0|
|131072|2|438.0|365.0|
|131072|4|437.0|362.0|
|131072|8|437.0|362.0|
|131072|16|437.0|365.0|
|131072|32|658.0|366.0|
|131072|64|440.0|360.0|
|131072|128|437.0|365.0|
|262144|1|871.0|730.0|
|262144|2|873.0|725.0|
|262144|4|871.0|727.0|
|262144|8|871.0|721.0|
|262144|16|871.0|730.0|
|262144|32|874.0|728.0|
|262144|64|871.0|722.0|
|262144|128|870.0|729.0|
|524288|1|1744.0|1458.0|
|524288|2|1739.0|1455.0|
|524288|4|1745.0|1447.0|
|524288|8|1740.0|1451.0|
|524288|16|1742.0|1447.0|
|524288|32|1739.0|1442.0|
|524288|64|1752.0|1453.0|
|524288|128|1745.0|1455.0|
Test ./target_O2
|Matrix Size|Prefetch Offset|Time With Prefetch|Time Without Prefetch (us)|
|-|-|-:|-:|
|4|1|2.0|1.0|
|4|2|2.0|1.0|
|4|4|2.0|1.0|
|4|8|2.0|1.0|
|4|16|2.0|1.0|
|4|32|3.0|1.0|
|4|64|4.0|3.0|
|4|128|2.0|1.0|
|8|1|2.0|1.0|
|8|2|3.0|1.0|
|8|4|2.0|2.0|
|8|8|2.0|1.0|
|8|16|5.0|2.0|
|8|32|3.0|1.0|
|8|64|5.0|2.0|
|8|128|3.0|1.0|
|16|1|3.0|1.0|
|16|2|2.0|1.0|
|16|4|5.0|3.0|
|16|8|2.0|1.0|
|16|16|4.0|3.0|
|16|32|2.0|1.0|
|16|64|2.0|1.0|
|16|128|3.0|2.0|
|32|1|4.0|2.0|
|32|2|2.0|2.0|
|32|4|4.0|4.0|
|32|8|3.0|1.0|
|32|16|2.0|1.0|
|32|32|3.0|1.0|
|32|64|6.0|2.0|
|32|128|3.0|1.0|
|64|1|4.0|2.0|
|64|2|2.0|1.0|
|64|4|2.0|2.0|
|64|8|2.0|2.0|
|64|16|4.0|4.0|
|64|32|2.0|2.0|
|64|64|4.0|2.0|
|64|128|2.0|1.0|
|128|1|3.0|2.0|
|128|2|2.0|2.0|
|128|4|5.0|6.0|
|128|8|3.0|2.0|
|128|16|5.0|3.0|
|128|32|2.0|2.0|
|128|64|3.0|1.0|
|128|128|3.0|2.0|
|256|1|6.0|4.0|
|256|2|3.0|1.0|
|256|4|5.0|3.0|
|256|8|3.0|3.0|
|256|16|3.0|1.0|
|256|32|3.0|2.0|
|256|64|2.0|3.0|
|256|128|3.0|3.0|
|512|1|4.0|2.0|
|512|2|4.0|4.0|
|512|4|8.0|15.0|
|512|8|4.0|2.0|
|512|16|8.0|7.0|
|512|32|4.0|2.0|
|512|64|4.0|2.0|
|512|128|4.0|2.0|
|1024|1|11.0|7.0|
|1024|2|5.0|4.0|
|1024|4|11.0|8.0|
|1024|8|5.0|4.0|
|1024|16|6.0|3.0|
|1024|32|6.0|6.0|
|1024|64|6.0|4.0|
|1024|128|5.0|4.0|
|2048|1|9.0|6.0|
|2048|2|8.0|10.0|
|2048|4|9.0|13.0|
|2048|8|20.0|19.0|
|2048|16|9.0|10.0|
|2048|32|19.0|16.0|
|2048|64|9.0|9.0|
|2048|128|9.0|7.0|
|4096|1|16.0|12.0|
|4096|2|20.0|15.0|
|4096|4|20.0|12.0|
|4096|8|33.0|25.0|
|4096|16|16.0|12.0|
|4096|32|32.0|26.0|
|4096|64|16.0|12.0|
|4096|128|15.0|13.0|
|8192|1|29.0|24.0|
|8192|2|53.0|29.0|
|8192|4|30.0|24.0|
|8192|8|61.0|50.0|
|8192|16|30.0|24.0|
|8192|32|60.0|50.0|
|8192|64|30.0|24.0|
|8192|128|29.0|24.0|
|16384|1|56.0|47.0|
|16384|2|56.0|47.0|
|16384|4|57.0|47.0|
|16384|8|117.0|97.0|
|16384|16|56.0|47.0|
|16384|32|117.0|114.0|
|16384|64|57.0|47.0|
|16384|128|117.0|97.0|
|32768|1|150.0|93.0|
|32768|2|316.0|193.0|
|32768|4|151.0|94.0|
|32768|8|305.0|193.0|
|32768|16|153.0|93.0|
|32768|32|307.0|193.0|
|32768|64|153.0|93.0|
|32768|128|306.0|193.0|
|65536|1|302.0|185.0|
|65536|2|604.0|215.0|
|65536|4|303.0|185.0|
|65536|8|296.0|186.0|
|65536|16|303.0|186.0|
|65536|32|305.0|186.0|
|65536|64|295.0|186.0|
|65536|128|599.0|384.0|
|131072|1|591.0|370.0|
|131072|2|610.0|371.0|
|131072|4|609.0|370.0|
|131072|8|594.0|370.0|
|131072|16|802.0|370.0|
|131072|32|588.0|370.0|
|131072|64|596.0|370.0|
|131072|128|1016.0|372.0|
|262144|1|1239.0|745.0|
|262144|2|1231.0|739.0|
|262144|4|1210.0|742.0|
|262144|8|1227.0|739.0|
|262144|16|1201.0|739.0|
|262144|32|1181.0|739.0|
|262144|64|1226.0|744.0|
|262144|128|1203.0|739.0|
|524288|1|2521.0|1477.0|
|524288|2|2453.0|1482.0|
|524288|4|2442.0|1486.0|
|524288|8|2454.0|1480.0|
|524288|16|2449.0|1477.0|
|524288|32|2464.0|1478.0|
|524288|64|2440.0|1480.0|
|524288|128|2486.0|1477.0|
Test ./target_O3
|Matrix Size|Prefetch Offset|Time With Prefetch|Time Without Prefetch (us)|
|-|-|-:|-:|
|4|1|4.0|2.0|
|4|2|2.0|1.0|
|4|4|3.0|1.0|
|4|8|2.0|1.0|
|4|16|3.0|1.0|
|4|32|3.0|1.0|
|4|64|5.0|2.0|
|4|128|2.0|1.0|
|8|1|4.0|2.0|
|8|2|2.0|0.0|
|8|4|2.0|1.0|
|8|8|2.0|1.0|
|8|16|4.0|2.0|
|8|32|2.0|1.0|
|8|64|4.0|2.0|
|8|128|2.0|0.0|
|16|1|2.0|1.0|
|16|2|3.0|1.0|
|16|4|4.0|2.0|
|16|8|2.0|0.0|
|16|16|3.0|2.0|
|16|32|2.0|0.0|
|16|64|2.0|0.0|
|16|128|3.0|1.0|
|32|1|2.0|1.0|
|32|2|3.0|1.0|
|32|4|2.0|1.0|
|32|8|3.0|1.0|
|32|16|4.0|2.0|
|32|32|2.0|1.0|
|32|64|5.0|2.0|
|32|128|3.0|1.0|
|64|1|3.0|1.0|
|64|2|3.0|1.0|
|64|4|3.0|0.0|
|64|8|2.0|1.0|
|64|16|2.0|1.0|
|64|32|2.0|1.0|
|64|64|2.0|1.0|
|64|128|2.0|1.0|
|128|1|5.0|3.0|
|128|2|3.0|1.0|
|128|4|3.0|1.0|
|128|8|2.0|1.0|
|128|16|3.0|1.0|
|128|32|3.0|1.0|
|128|64|4.0|1.0|
|128|128|3.0|0.0|
|256|1|5.0|3.0|
|256|2|3.0|1.0|
|256|4|2.0|1.0|
|256|8|2.0|1.0|
|256|16|8.0|3.0|
|256|32|2.0|1.0|
|256|64|5.0|1.0|
|256|128|2.0|2.0|
|512|1|3.0|2.0|
|512|2|3.0|1.0|
|512|4|10.0|2.0|
|512|8|5.0|2.0|
|512|16|11.0|3.0|
|512|32|3.0|1.0|
|512|64|6.0|1.0|
|512|128|4.0|1.0|
|1024|1|5.0|1.0|
|1024|2|4.0|1.0|
|1024|4|12.0|3.0|
|1024|8|4.0|1.0|
|1024|16|4.0|2.0|
|1024|32|4.0|1.0|
|1024|64|5.0|2.0|
|1024|128|4.0|1.0|
|2048|1|12.0|4.0|
|2048|2|6.0|4.0|
|2048|4|10.0|2.0|
|2048|8|5.0|4.0|
|2048|16|6.0|2.0|
|2048|32|9.0|2.0|
|2048|64|27.0|4.0|
|2048|128|12.0|4.0|
|4096|1|14.0|2.0|
|4096|2|9.0|3.0|
|4096|4|27.0|6.0|
|4096|8|8.0|3.0|
|4096|16|25.0|6.0|
|4096|32|11.0|3.0|
|4096|64|11.0|2.0|
|4096|128|18.0|6.0|
|8192|1|16.0|5.0|
|8192|2|16.0|5.0|
|8192|4|17.0|5.0|
|8192|8|33.0|11.0|
|8192|16|15.0|5.0|
|8192|32|36.0|10.0|
|8192|64|18.0|5.0|
|8192|128|17.0|5.0|
|16384|1|30.0|8.0|
|16384|2|49.0|10.0|
|16384|4|29.0|9.0|
|16384|8|61.0|19.0|
|16384|16|29.0|9.0|
|16384|32|60.0|18.0|
|16384|64|29.0|9.0|
|16384|128|29.0|9.0|
|32768|1|101.0|18.0|
|32768|2|103.0|17.0|
|32768|4|97.0|17.0|
|32768|8|204.0|36.0|
|32768|16|103.0|17.0|
|32768|32|200.0|36.0|
|32768|64|102.0|17.0|
|32768|128|198.0|36.0|
|65536|1|202.0|33.0|
|65536|2|389.0|70.0|
|65536|4|195.0|34.0|
|65536|8|383.0|70.0|
|65536|16|211.0|34.0|
|65536|32|205.0|34.0|
|65536|64|197.0|33.0|
|65536|128|196.0|34.0|
|131072|1|393.0|66.0|
|131072|2|383.0|67.0|
|131072|4|764.0|85.0|
|131072|8|397.0|68.0|
|131072|16|388.0|66.0|
|131072|32|390.0|68.0|
|131072|64|379.0|66.0|
|131072|128|378.0|66.0|
|262144|1|1507.0|134.0|
|262144|2|782.0|136.0|
|262144|4|826.0|136.0|
|262144|8|798.0|146.0|
|262144|16|845.0|149.0|
|262144|32|803.0|147.0|
|262144|64|807.0|138.0|
|262144|128|792.0|135.0|
|524288|1|1709.0|272.0|
|524288|2|1646.0|276.0|
|524288|4|1629.0|291.0|
|524288|8|1650.0|280.0|
|524288|16|1631.0|288.0|
|524288|32|1639.0|275.0|
|524288|64|1632.0|296.0|
|524288|128|1647.0|287.0|
### Conclusion with prefetch

Analyzing the metrics, we can say that the execution time with prefetching is generally comparable to or bigger than the time without prefetching depending the prefetching offsets.

Here is a detail for each type of compilation:
- For O0, regardless of offset size of prefetching and the matrix size, the execution time with prefetching is bigger than the time without prefetching.

- For O1, the conclusion is the same as O0.

- For O2, the execution time is bigger with prefetching and it can be ~2x bigger than the time without prefetching.

- For O3, the execution time is bigger with prefetching and it can be ~5x bigger than the time without prefetching.

In some setups, prefetching can add overhead, likely because fetching data in advance may not fully match the algorithm’s immediate requirements.

If we optimze the code during the compilation, the manual prefetching can bypass the compiler's optimization and it add overhead to the execution time.

## Stage 4

|                  | L1 Cache Loads       | L1 Cache Load Misses    | Total Time     |
|------------------|----------------------|-------------------------|----------------|
| No Prefetch      | 19,001,489,115       | 756,692,341            | 27,590,978 μs  |
| With Prefetch    | 17,856,699,442       | 501,445,402            | 26,504,687 μs  |

The performance measurements reveal the clear benefits of prefetching for improving cache utilization and reducing overall execution time. Here are the key findings:

- **Total Execution Time:** Prefetching also reduces overall execution time, from 27.59 milliseconds to 26.50 milliseconds, providing a performance boost of around 3.95%. Although this improvement may seem modest, it highlights the impact of prefetching in scenarios where data access speed is crucial.

- **L1 Cache Loads:** When prefetching is enabled, the total L1 cache loads decrease slightly (from about 19 billion to 17.86 billion). This suggests that prefetching helps streamline memory access, reducing the cache's workload and promoting efficient memory usage.

- **L1 Cache Load Misses:** The reduction in L1 cache load misses is particularly notable, dropping significantly with prefetching—from 756 million to 501 million. This demonstrates that the prefetching mechanism has effectively anticipated data needs, resulting in fewer delays when the processor retrieves data from main memory.

